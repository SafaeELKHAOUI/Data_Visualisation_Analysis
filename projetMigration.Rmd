---
title: "Migration Animal"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bootswatch: minty
    orientation: columns
    vertical_layout: fill
    source_code: embed
    logo: fa-solid fa-gauge
runtime: shiny
css: style.css
resource_files:
- data.csv
- location_with_temperature_altitude.csv
- data_nettoyee_V1.csv
- cigogne.csv
---

```{r setup, include=FALSE}

library(flexdashboard)
library(shiny)
library(leaflet)
library(ggplot2)
library(plotly)
library(dplyr)
library(DT)
library(leaflet.extras)
library(leaflet.providers)
library(lubridate)
library(zoo)

caribou_temp_alt <- read.csv("location_with_temperature_altitude.csv")
caribou <- read.csv("caribou.csv")
caribou_all <- read.csv("locations.csv")
# Convert timestamp to proper date format
caribou_all$timestamp <- ymd_hms(caribou_all$timestamp)

cigogne_big <- read.csv("data_nettoyee_V1.csv",sep=";")
cigogne <- read.csv("cigogne.csv")

# Fonction pour calculer la distance entre deux points g√©ographiques
distance_between_points <- function(longitude, latitude) {
  # Convertir les coordonn√©es en radians
  lon1 <- longitude[-length(longitude)] * pi / 180
  lon2 <- longitude[-1] * pi / 180
  lat1 <- latitude[-length(latitude)] * pi / 180
  lat2 <- latitude[-1] * pi / 180
 
  # Calculer la distance entre les points avec la formule de la distance orthodromique
  d <- 6371 * acos(sin(lat1) * sin(lat2) + cos(lat1) * cos(lat2) * cos(lon2 - lon1))
 
  # Retourner la distance en kilom√®tres
  return(d)
}

# Fonction pour g√©n√©rer une couleur al√©atoire 
generate_random_color <- function() {
  # G√©n√©rer des valeurs RGB al√©atoires entre 0 et 255
  red <- sample(50:255, 1)
  green <- sample(50:255, 1)
  blue <- sample(50:255, 1)
  # Construire la couleur au format hexad√©cimal
  color <- rgb(red, green, blue, maxColorValue = 255)
  return(color)
}

#Garder que les Animaux avec plus qu'une occurence + enlever les lignes avec des NA

caribou_temp_alt <- na.omit(caribou_temp_alt)
animal_id_counts <- table(caribou_temp_alt$animal_id)
caribou_temp_alt <- caribou_temp_alt[caribou_temp_alt$animal_id %in% names(animal_id_counts[animal_id_counts > 1]), ]

#Garder que les Animaux avec plus qu'une occurence + enlever les lignes avec des NA
cigogne <- na.omit(cigogne)
animal_id_counts <- table(cigogne$nom)
cigogne <- cigogne[cigogne$nom %in% names(animal_id_counts[animal_id_counts > 1]), ]

```

# üè† Pr√©sentation

Column {data-width=450}
-------------------------------------
### Contexte

  Le r√©chauffement climatique devient une pr√©occupation majeure ces derni√®res ann√©es, d‚Äôautant plus qu‚Äôil impacte fortement la conservation et l‚Äôenvironnement de certaines esp√®ces animales. L‚Äô√©tude des comportements migratoires des animaux est un domaine de plus en plus √©tudi√© par les professionnels afin d‚Äôaider √† la sauvegarde des esp√®ces animales et v√©g√©tales en relevant les facteurs externes qui tendent √† bouleverser et impacter le plus les √©cosyst√®mes et animaux. Parmi eux, l‚Äô√©l√©vation constantes des temp√©ratures, caus√©e par le r√©chauffement climatique, et leurs variations intenses peuvent √™tre √† l‚Äôorigine de changements de comportement des esp√®ces animales qui s‚Äôadaptent √† un nouvel environnement

  Nous nous int√©resserons donc ici aux changements d‚Äôhabitudes migratoires, potentiellement impact√©e par la temp√©rature sur une quinzaine d‚Äôann√©es de deux esp√®ces menac√©es et en voie d‚Äôextinction : le caribou des bois (√©cotype montagnard) et la cigogne blanche europ√©enne.
  
  L‚Äôobjectif premier sera donc de d√©montrer une corr√©lation entre les variations des temp√©ratures annuelles dans les zones de migrations connues et la distance parcourue par ces animaux pendant leur p√©riode de migration, ainsi que leur p√©riode de migration.


Column {data-width=550}
-------------------------------------

### Objectif et Probl√©matique

Dans cette √©tude, nous analyserons donc l‚Äô√©volution de la distance moyenne et de l‚Äôaltitude moyenne (quand cela est pertinent) des trajets de migration des animaux au fil des saisons et au fil des ann√©es. Nous souhaitons notamment mettre en lumi√®re les potentiels changements de comportements des animaux (allongement des p√©riodes de migration, distances de migration r√©duites‚Ä¶) au fils des ans, ce qui pourrait √™tre reli√© entre autre √† des changements de temp√©rature.


### Collecte de donn√©es

  Pour cette √©tude, nous avons utilis√© la banque de donn√©es Movebank. Cette derni√®re dont nous avons scrapp√© les donn√©es GPS de nos animaux est une database gratuite h√©berg√©e par l‚ÄôInstitut Max Planck qui √©tudie les comportements des animaux. Nous avons aussi utilis√© l‚ÄôAPI d‚ÄôOpen Archive m√©t√©o pour r√©cup√©rer les temp√©ratures sur les 30 derni√®res ann√©es des zones de migrations de la cigogne et du caribou. Nous avons par la suite d√ª traiter pr√®s de 1 million de donn√©es pour les caribous et pr√®s de 12 millions de donn√©es pour les cigognes juste pour r√©cup√©rer les coordonn√©es GPS des animaux et pouvoir les afficher de mani√®re simple. En effet, les donn√©es GPS que nous avions collect√©es sont issues de donn√©es de t√©l√©m√©tries d‚Äôanimaux bagu√©es, qui enregistrent la position de l‚Äôanimal toutes les 2min durant plusieurs ann√©es cons√©cutives. 

  Gr√¢ce au traitement des donn√©es, nous avons ainsi pu analyser le trajet de migration de 150 cigognes et de 170 caribous sur une p√©riode d‚Äôenviron 15 ans chacune.
  
  Etant donn√© que r√©cup√©rer et afficher les temp√©ratures sur les trentes derni√®res ann√©es sur des zones √©tendues n‚Äôest pas r√©alisable, nous avons choisis des points sp√©cifiques gps par o√π passent les animaux et la date √† laquelle ils y sont pass√©s. 

### Fait Par

- Lena Connesson
- Safae Elkhaoui
- Lucie Legarez
- Marc Cheng
- Omar Benouahi


# üìä Donn√©es Finales

Column {.tabset data-width="750"}
-----------------------------------------------------------------------

### Caribou

```{r}
datatable(caribou, options = list(pageLength = 25, dom = 'Bfrtip', buttons = c('csv')) ,extensions = 'Buttons')
```

### Cigogne

```{r}
datatable(cigogne, options = list(pageLength = 25, dom = 'Bfrtip', buttons = c('csv')),extensions = 'Buttons')
```

### Remarque

<div style="margin-left: 20px; margin-right: 20px;">
 <p style="font-size: 16px; line-height: 1.5;"> 
Pour optimiser les performances du dashboard et acc√©l√©rer le traitement des donn√©es, nous avons d√ª r√©duire le nombre de donn√©es initiales. Pour ce faire, nous avons adopt√© une approche consistant √† agr√©ger les donn√©es pour chaque mois, plut√¥t que de conserver chaque point de donn√©es individuel. Ainsi, au lieu de traiter 30 ou 31 points de donn√©es par mois, nous avons calcul√© la moyenne des donn√©es pour chaque mois, ce qui a consid√©rablement r√©duit le volume de donn√©es √† g√©rer qui √©tait (70 000 Pour les cigognes et 122900 pour les caribous).
 </p>
 <p style="font-size: 16px; line-height: 1.5;"> 
Cette m√©thode nous a permis de ramener le nombre de donn√©es √† environ 5500 pour les Caribous et 2600 pour les cigognes. De plus, pour les donn√©es de temp√©rature, nous avons utilis√© une API m√©t√©o via un script Python (voir <a href="https://drive.google.com/drive/u/2/folders/1M5tVUmKraY0MBubz-rMw8xOXievDtkMX" target="_blank">ce lien</a> pour plus de d√©tails). Enfin, pour l'altitude, nous avons fait appel √† une biblioth√®que R d√©di√©e.
 </p>
</div>
 
 
# üó∫Ô∏è Analyse des trajets

Column {.tabset data-width="750"}
-----------------------------------------------------------------------

### Caribou

```{r}
# Configuration de l'interface utilisateur
ui <- fluidPage(
  titlePanel(
    HTML("<span style='color: black; font-size: 30px; font-family: Cursive; font-weight: bold;'>Analyse des trajectoires de migration des caribous</span>")
  ),
  sidebarLayout(
    sidebarPanel(
      radioButtons("analysis_choice", HTML("<span style='color: #8B0000;'>Choix d'analyse :</span>"), 
                   choices = c("Analyser un caribou" = "single", "Comparer plusieurs caribous" = "multiple"), 
                   selected = "single"),
      
      tags$hr(class = "custom-hr"),
      
      conditionalPanel(
        condition = "input.analysis_choice == 'single'",
        selectInput("caribou_id_single", HTML("<span style='color: #8B0000;'>S√©lectionner un caribou :</span>"), 
                    choices = sort(unique(caribou_temp_alt$animal_id)))
      ),
      conditionalPanel(
        condition = "input.analysis_choice == 'multiple'",
        selectizeInput("caribou_id_multiple", HTML("<span style='color: #8B0000;'>S√©lectionner un ou plusieurs caribous :</span>"), 
                       choices = sort(unique(caribou_temp_alt$animal_id)), multiple = TRUE)
      ),
      
      tags$hr(class = "custom-hr"),
      
      checkboxGroupInput("show_options", HTML("<span style='color: #8B0000;'>Options d'affichage :</span>"), 
                         choices = list("Afficher la trajectoire" = "trajectory",
                                        "Afficher les positions" = "positions")),
      
      tags$hr(class = "custom-hr"),
      
      uiOutput("date_ui"),
      checkboxGroupInput("migration_options", HTML("<span style='color: #8B0000;'>Param√®tres de migration :</span>"), 
                         choices = list("Temp√©rature" = "temperature",
                                        "Altitude" = "altitude"),
                         selected = "Temp√©rature"),
      
      conditionalPanel(
        
        condition = "input.migration_options.includes('altitude')",
        radioButtons("altitude_display_option", HTML("<span style='color: #8B0000;'>Affichage de l'altitude :</span>"), 
                     choices = c("Carte en relief" = "altitude_map",
                                 "Marqueurs d'altitude" = "altitude_markers"),
                     selected = "altitude_map"),
        
      )
    ),
    mainPanel(
      # Utilisation de la classe "style" pour d√©finir la taille de la carte
      leafletOutput("migration_map", width = "100%", height = "600px")
    )
  ),
  tags$style(type = "text/css", "#migration_map { padding: 0px; margin: 0px; }"),
  tags$style(
    type = "text/css",
    HTML("
  .custom-hr {
    border: none; /* Supprimer la bordure */
    height: 1px; /* Hauteur de la ligne */
    background-color: black; /* Couleur de la ligne */
    margin: 25px 0; /* Marge au-dessus et en dessous de la ligne */
  }
")
  ),
)


#Configuration du server
server <- function(input, output, session) {
  
  output$date_ui <- renderUI({
    req(input$show_options)
    if ("positions" %in% input$show_options && "single" %in% input$analysis_choice){
      caribou_data <- get_selected_caribou_data(input)
      caribou_dates <- unique(caribou_data$timestamp)
      
      sliderInput("date_slider", "S√©lectionner une date :", 
                  min = min(as.Date(caribou_dates)),
                  max = max(as.Date(caribou_dates)),
                  value = min(as.Date(caribou_dates)))
      
    } else if ("positions" %in% input$show_options && "multiple" %in% input$analysis_choice){
      
      if ("positions" %in% input$show_options && !is.null(input$caribou_id_multiple)) {
        
        caribou_data <- get_selected_caribou_data(input)
        caribou_dates <- unique(caribou_data$timestamp)
        
        sliderInput("date_slider", "S√©lectionner une date :", 
                    min = min(as.Date(caribou_dates)),
                    max = max(as.Date(caribou_dates)),
                    value = min(as.Date(caribou_dates)))  
      } else {
        NULL
      }
    } else {
      NULL
    }
  })
  
  output$migration_map <- renderLeaflet({
    caribou_data <- get_selected_caribou_data(input)
    
    map <- leaflet() %>%
      addTiles() %>%
      addScaleBar(position = "bottomleft")
    
    if ("altitude" %in% input$migration_options) {
      if (input$altitude_display_option == "altitude_map") {
        map <- clearTiles(map) %>%
          addProviderTiles(providers$OpenTopoMap)
      } else if (input$altitude_display_option == "altitude_markers") {
        map <- add_caribou_elevation_map(map, caribou_data)
      }
    }
    
    if ("trajectory" %in% input$show_options) {
      map <- add_caribou_trajectories(map, caribou_data)
    }
    
    if ("positions" %in% input$show_options) {
      map <- add_caribou_positions(map, caribou_data, input$date_slider)
    }
    
    if ("temperature" %in% input$migration_options) {
      map <- add_caribou_heatmap(map, caribou_data)
    }
    
    map <- add_caribou_legend(map, caribou_data)
    
    map
  })
}


# Fonction pour calculer les limites des temp√©ratures pour chaque caribou
calculate_temp_limits <- function(caribou_data) {
  if (nrow(caribou_data) == 0) {
    return(c(0, 0))
  } else {
    min_temp <- min(caribou_data$temperature) - 0.01
    max_temp <- max(caribou_data$temperature) + 0.01
    return(c(min_temp, max_temp))
  }
}


# Fonction pour cr√©er une palette de couleurs personnalis√©e pour les temp√©ratures
create_custom_palette <- function(n) {
  colors <- colorRampPalette(c("blue", "green", "yellow", "orange", "red"))(n)
  return(colors)
}


# Fonction pour ajouter la carte des temp√©ratures
add_caribou_heatmap <- function(map, caribou_data) {
  temp_limits <- calculate_temp_limits(caribou_data)
  min_temp <- temp_limits[1] 
  max_temp <- temp_limits[2] 
  
  breaks <- seq(min_temp, max_temp, length.out = 5)  
  normalized_temps <- (caribou_data$temperature - min_temp) / (max_temp - min_temp)
  
  color_palette <- create_custom_palette(100)
  colors <- color_palette[findInterval(normalized_temps * 100, seq(0, 100))]
  
  map <- addCircleMarkers(map, lng = caribou_data$longitude, lat = caribou_data$latitude,
                          radius = 5, color = colors, fillOpacity = 0.7)
  
  map <- addLegend(map = map, pal = colorNumeric(palette = color_palette, domain = breaks),
                   values = breaks, position = "bottomright", title = "Temp√©rature (¬∞C)",
                   opacity = 0.5)
  map
}


# Fonction pour calculer les limites de l'altitude pour chaque caribou
calculate_elevation_limits <- function(caribou_data) {
  if (nrow(caribou_data) == 0) {
    return(c(0, 0))
  } else {
    min_elevation <- min(caribou_data$elevation)
    max_elevation <- max(caribou_data$elevation)
    return(c(min_elevation, max_elevation))
  }
}


# Fonction pour cr√©er une palette de couleurs personnalis√©e pour l'altitude
create_elevation_palette <- function(n) {
  colors <- colorRampPalette(c("white", "black"))(n)
  return(colors)
}


# Fonction pour ajouter la carte de l'altitude
add_caribou_elevation_map <- function(map, caribou_data) {
  elevation_limits <- calculate_elevation_limits(caribou_data)
  min_elevation <- elevation_limits[1]
  max_elevation <- elevation_limits[2]
  
  breaks <- seq(min_elevation, max_elevation, length.out = 5)
  normalized_elevation <- (caribou_data$elevation - min_elevation) / (max_elevation - min_elevation)
  reversed_normalized_elevation <- 1 - normalized_elevation
  
  elevation_palette <- create_elevation_palette(100)
  colors <- elevation_palette[findInterval(reversed_normalized_elevation * 100, seq(0, 100))]
  
  map <- addCircleMarkers(map, lng = caribou_data$longitude, lat = caribou_data$latitude,
                          radius = 10, color = colors, fillOpacity = 0, weight = 5)
  
  map <- addLegend(map = map, pal = colorNumeric(palette = elevation_palette, domain = breaks),
                   values = breaks, position = "bottomleft", title = "Altitude (¬∞m)",
                   opacity = 0.5)
  map
}


# Fonction pour obtenir les donn√©es du caribou s√©lectionn√©
get_selected_caribou_data <- function(input) {
  if (input$analysis_choice == "single") {
    subset(caribou_temp_alt, animal_id == input$caribou_id_single)
  } else {
    subset(caribou_temp_alt, animal_id %in% input$caribou_id_multiple)
  }
}


# Fonction pour ajouter les positions des caribous √† la carte pour une date sp√©cifique
add_caribou_positions <- function(map, caribou_data, date) {
  num_caribous <- length(unique(caribou_data$animal_id))
  if (num_caribous > 1) {
    colors <- rainbow(num_caribous)
  } else {
    colors <- "red"
  }
  caribou_ids <- unique(caribou_data$animal_id)
  
  for (i in 1:num_caribous) {
    caribou_data$timestamp <- as.Date(caribou_data$timestamp)
    caribou_subset <- subset(caribou_data, animal_id == caribou_ids[i] & timestamp == date)
    if (nrow(caribou_subset) > 0) {
      map <- map %>%
        addMarkers(data = caribou_subset, lng = ~longitude, lat = ~latitude,
                   popup = ~paste("<b>Identifiant :", animal_id, "</b> <br>Latitude :", latitude, "<br>Longitude :", longitude, "<br>Temp√©rature :", temperature, "¬∞C", "<br>Altitude :", elevation, "m" )) # Utilisation de la couleur correspondant √† chaque caribou
    }
  }
  map
}


# Fonction pour ajouter les trajectoires des caribous
add_caribou_trajectories <- function(map, caribou_data) {
  num_caribous <- length(unique(caribou_data$animal_id))
  if (num_caribous > 1) {
    colors <- rainbow(num_caribous)
  } else {
    colors <- "red"
  }
  caribou_ids <- unique(caribou_data$animal_id)
  
  for (i in 1:num_caribous) {
    caribou_subset <- subset(caribou_data, animal_id == caribou_ids[i])
    map <- map %>%
      addPolylines(data = caribou_subset, lng = ~longitude, lat = ~latitude,
                   color = colors[i], weight = 2,
                   label = HTML(paste("<b><u> Caribou</u> : </b> ", caribou_ids[i]))) %>%
      setView(mean(caribou_data$longitude), mean(caribou_data$latitude), zoom = 10)
  }
  map
}


#Ajout de la l√©gende √† la carte
add_caribou_legend <- function(map, caribou_data) {
  if (nrow(caribou_data) > 0) {
    map <- map %>%
      addControl(position = "topright",  html = paste("<b>Zone :</b>", unique(caribou_data$study_site)))
  }
  map
}


#Lancement de shiny
shinyApp(ui = ui, server = server)
```
 
 
 
 
  
### Cigogne

```{r}
# D√©finir le UI
ui <- fluidPage(
  titlePanel("Carte de trajectoire de migration pour chaque cigogne"),
  sidebarLayout(
    sidebarPanel(
      radioButtons("mode", "Mode d'analyse :", choices = c("Analyser une cigogne", "Comparer plusieurs cigognes")),
      uiOutput("cigogne_selector")
    ),
    mainPanel(
      leafletOutput("migration_map", width = "100%", height = "600px")
    )
  )
)

# D√©finir le server
server <- function(input, output, session) {
  
  # S√©lecteur de cigogne unique si "Analyser une cigogne" est s√©lectionn√©
  output$cigogne_selector <- renderUI({
    if (input$mode == "Analyser une cigogne") {
      selectInput("nom", "S√©lectionner une cigogne :", choices = sort(unique(cigogne$nom)))
    } else {
      selectizeInput("nom_multiple", "S√©lectionner plusieurs cigognes :", choices = sort(unique(cigogne$nom)), multiple = TRUE)
    }
  })
  
  # Carte de migration
  output$migration_map <- renderLeaflet({
    if (input$mode == "Analyser une cigogne") {
      cigogne_data <- subset(cigogne, nom == input$nom)
      leaflet() %>%
        addTiles() %>%
        addPolylines(data = cigogne_data, lng = ~longitude, lat = ~latitude,
                     color = "red", weight = 2)
    } else {
      # Assigner une couleur diff√©rente √† chaque cigogne
      colors <- rainbow(length(input$nom_multiple))
      cigognes_data <- subset(cigogne, nom %in% input$nom_multiple)
      
      # Ajouter les polylignes pour chaque cigogne avec sa couleur correspondante
      map <- leaflet() %>%
        addTiles()
      
      for (i in 1:length(input$nom_multiple)) {
        cigogne_subset <- subset(cigognes_data, nom == input$nom_multiple[i])
        map <- addPolylines(map, data = cigogne_subset, lng = ~longitude, lat = ~latitude,
                            color = colors[i], weight = 2)
      }
      
      map
    }
  })
}

# Lancer l'application Shiny
shinyApp(ui = ui, server = server)
```
 

 
 
 
# Caribou {data-navmenu="üìà Analyse de donn√©e"}

Column {.tabset}
-----------------------------------------------------------------------

### Distance parcourue par caribou
```{r}
ui <- fluidPage(
  titlePanel(HTML("<span style='color: black; font-size: 30px; font-family: Cursive; font-weight: bold;'>Distance (en km) parcourue par caribou par mois</span>")),
  sidebarLayout(
    sidebarPanel(
      selectInput("yearInput", "Choisir une ann√©e :", choices = unique(year(caribou_all$timestamp)) , selected = "2006"),
      selectInput("monthInput", "Choisir un mois :", choices = month.name, selected = month.name[1])
    ),
    mainPanel(
      uiOutput("plotOrMessage"),
      dataTableOutput("distanceTable")
    )
  )
)


#Configuration du server
server <- function(input, output, session) {
  
  distance_by_caribou <- reactive({
    tryCatch({
      filtered_data <- caribou_all[year(caribou_all$timestamp) == input$yearInput & month(caribou_all$timestamp) == match(input$monthInput, month.name), ]
      
      complete_month_caribous <- filtered_data 
      if (nrow(complete_month_caribous) == 0) {
        return(NULL)
      }
      
      distance_data <- complete_month_caribous %>%
        arrange(timestamp) %>%
        group_by(animal_id) %>%
        summarise(distance_totale = sum(distance_between_points(longitude, latitude)))
      
      print(distance_data)
      
      return(distance_data)
    }, error = function(e) {
      return(NULL)
    })
  })
  
  
  output$plotOrMessage <- renderUI({
    if (is.null(distance_by_caribou())) {
      return(tags$h3("Les donn√©es n'ont pas √©t√© r√©cup√©r√©es sur cette p√©riode, veuillez s√©lectionner une autre p√©riode.")) 
    } else {
      return(plotOutput("distancePlot")) 
    }
  })
  
  
  output$distancePlot <- renderPlot({
    if (is.null(distance_by_caribou())) {
      return(NULL)
    }
    
    ggplot(distance_by_caribou(), aes(x = animal_id, y = distance_totale)) +
      geom_bar(stat = "identity", fill = "skyblue") +
      labs(title = paste("Distance parcourue par caribou en", input$monthInput, input$yearInput),
           x = "Caribou", y = "Distance totale parcourue (km)") + 
      theme(axis.text.x = element_text(angle = 45, hjust = 1))  
  })
  
  
  output$distanceTable <- renderDataTable({
    if (is.null(distance_by_caribou())) {
      return(NULL)
    }
    distance_by_caribou()
  })
}


#Calcul de la distance en km
distance_between_points <- function(longitude, latitude, altitude = 1500) {
  # Convertir les coordonn√©es en radians
  lon1 <- longitude[-length(longitude)] * pi / 180
  lon2 <- longitude[-1] * pi / 180
  lat1 <- latitude[-length(latitude)] * pi / 180
  lat2 <- latitude[-1] * pi / 180
  
  d_2d <- 6371 * acos(sin(lat1) * sin(lat2) + cos(lat1) * cos(lat2) * cos(lon2 - lon1))
  d_3d <- sqrt(d_2d^2 + 1.5^2)
  return(d_3d)
}


# Lancer l'application Shiny
shinyApp(ui = ui, server = server)

```

### Distance Parcourue Par Mois
```{r}
# Configuration de l'interface utilisateur
ui <- fluidPage(
  titlePanel("Distance moyenne (en km) parcourue par un caribou par mois"),
  mainPanel(
    plotOutput("distancePlot")
  )
)

# Configuration du serveur
server <- function(input, output) {
  
  caribou_all$year <- year(caribou_all$timestamp)
  caribou_all$month <- month(caribou_all$timestamp)
  
  
  distance_data <- caribou_all %>%
    group_by(year, month, animal_id) %>%
    filter(n() >= 28) %>%  
    summarise(distance_totale = sum(distance_between_points(longitude, latitude)), .groups = "drop") %>%
    group_by(year, month) %>%
    summarise(distance_moyenne = mean(distance_totale), .groups = "drop")
  
  
  moyenne_par_mois <- distance_data %>%
    group_by(month) %>%
    summarise(moyenne_distance = mean(distance_moyenne), .groups = "drop")
  
  
  output$distancePlot <- renderPlot({
    ggplot() +
      geom_bar(data = distance_data, aes(x = factor(month, labels = month.name), y = distance_moyenne, fill = factor(year)), stat = "identity", position = position_dodge()) +
      geom_line(data = moyenne_par_mois, aes(x = factor(month, labels = month.name), y = moyenne_distance, group = 1, color = "Moyenne"), size=2) +
      labs(title = "Distance moyenne parcourue par un caribou pour chaque mois",
           x = "Mois", y = "Distance moyenne (km)",
           fill = "Ann√©e", color = "L√©gende") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      scale_color_manual(values = "red", labels = "Moyenne de toutes les ann√©es") +
      guides(fill = guide_legend(order = 1), color = guide_legend(order = 2))
  })
}


# Lancer l'application Shiny
shinyApp(ui = ui, server = server)


# Calcul de la distance en km
distance_between_points <- function(longitude, latitude, altitude = 1500) {
  lon1 <- longitude[-length(longitude)] * pi / 180
  lon2 <- longitude[-1] * pi / 180
  lat1 <- latitude[-length(latitude)] * pi / 180
  lat2 <- latitude[-1] * pi / 180
  
  d_2d <- 6371 * acos(sin(lat1) * sin(lat2) + cos(lat1) * cos(lat2) * cos(lon2 - lon1))
  d_3d <- sqrt(d_2d^2 + 1.5^2)
  return(d_3d)
}


```

<div style="margin-left: 50px; margin-right: 50px;"> 

### üìç Conclusion

#### Analyse des graphes Distances Parcourue

Les deux graphiques pr√©sentent des donn√©es sur la distance parcourue par les caribous tout au long de leur p√©riode de suivi de position. Le premier graphique offre une vue sur la distance moyenne parcourue au cours d'une ann√©e sp√©cifique et pour un mois donn√©, nous permettant ainsi d'appr√©hender l'√©tendue des d√©placements effectu√©s par les caribous pendant cette p√©riode. Il convient de noter que les p√©riodes de suivi GPS varient d'un caribou √† l'autre, ce qui peut entra√Æner des p√©riodes sans donn√©es √† afficher. Pour offrir une vue d'ensemble plus d√©taill√©e, un tableau r√©capitulatif affiche √©galement les distances exactes parcourues par les caribous.

Une observation importante r√©side dans la similarit√© des distances parcourues par les caribous d'une zone √† l'autre. En d'autres termes, les animaux vivant dans des zones diff√©rentes ne migrent pas n√©cessairement plus ou moins que ceux r√©sidant ailleurs. De plus, il est int√©ressant de noter que les distances parcourues demeurent relativement modestes, ne d√©passant jamais les 100 km par mois.

Quant au deuxi√®me graphique, il pr√©sente √©galement la distance moyenne parcourue par un caribou pour un mois donn√©, en prenant la moyenne des distances parcourues par diff√©rents caribous pour ce mois sp√©cifique. Ces moyennes sont repr√©sent√©es sous forme de barres, avec une courbe rouge illustrant la moyenne de toutes les ann√©es. 

Il est √† noter que les migrations les plus importantes surviennent g√©n√©ralement durant les mois d'automne, notamment en octobre et novembre. √Ä l'inverse, les mois de janvier √† avril montrent une diminution des d√©placements, probablement en raison des conditions hivernales plus extr√™mes, incitant les caribous √† adopter un comportement plus s√©dentaire.

En somme, les caribous des bois parcourent en moyenne environ 60 km par mois, totalisant ainsi environ 720 km par an. Contrairement √† d'autres esp√®ces de caribous, ils ne r√©alisent pas des migrations sur de longues distances. Leurs d√©placements sont plut√¥t conditionn√©s par les besoins saisonniers, les temp√©ratures et la disponibilit√© de leur habitat.

</div>
 
# Cigogne{data-navmenu="üìà Analyse de donn√©e"}

Column {.tabset}
-----------------------------------------------------------------------

### Distance parcourue par cigogne par Ann√©e/Mois

```{r}
cigogne <- cigogne_big
#HISTOGRAMME DES DISTANCES PARCOURUES EN FONCTION DES CIGOGNES ET ON CHOISIT LE MOIS + ANN√âES
# Cr√©er une application Shiny
ui <- fluidPage(
  titlePanel("Distance parcourue par cigogne par mois"),
  sidebarLayout(
	sidebarPanel(
  	selectInput("yearInput", "Choisir une ann√©e :", choices = unique(year(cigogne$date))),
  	selectInput("monthInput", "Choisir un mois :", choices = month.name, selected = month.name[1])
	),
	mainPanel(
  	plotlyOutput("distancePlot"),
  	dataTableOutput("distanceTable")
	)
  )
)

server <- function(input, output, session) {
  # Calculer la distance parcourue par chaque cigogne pour le mois s√©lectionn√© et l'ann√©e s√©lectionner
  distance_by_cigogne <- reactive({
    filtered_data <- cigogne %>%
      filter(year(date) == as.integer(input$yearInput) & month(date) == match(input$monthInput, month.name))
    
	# Calculer la distance parcourue entre deux points pour chaque cigogne
    distance_data <- filtered_data %>%
      arrange(date) %>%
      group_by(nom) %>%
      summarise(distance_totale = sum(distance_between_points(longitude, latitude)))

  
	 # Filtrer les donn√©es pour exclure les distances inf√©rieures √† 50 km
   #distance_data <- distance_data[distance_data$distance_totale >= 50, ]
    
	  
	return(distance_data)
  })
 
  # Afficher l'histogramme interactif
  output$distancePlot <- renderPlotly({
	ggplotly( 
	  ggplot(distance_by_cigogne(), aes(x = nom, y = distance_totale)) +
  	geom_bar(stat = "identity", fill = "skyblue") +
  	labs(title = paste("Distance totale parcourue par les cigognes en", input$monthInput, input$yearInput),
       	x = "cigogne", y = "Distance totale parcourue (km)") +  # Ajout de l'unit√© de distance
  	theme(axis.text.x = element_text(angle = -45, hjust = 1))  # Faire pivoter les √©tiquettes de l'axe x pour une meilleure lisibilit√©
  )
    })
  output$distanceTable <- renderDataTable({
	distance_by_cigogne()
  })
 
}

# Lancer l'application Shiny
shinyApp(ui = ui, server = server)

```

### Distance moyenne parcourue par mois par ann√©e

```{r}
cigogne <- cigogne_big
annees <- sort(unique(year(cigogne$date)))
# Cr√©er une application Shiny
ui <- fluidPage(
  titlePanel("Distance parcourue par cigogne par mois"),
  sidebarLayout(
	sidebarPanel(
  	selectInput("annees", "Choisir une ann√©e :", choices=annees)
  	),
	mainPanel(
  	plotlyOutput("distancePlot"),
	)
  )
)

server <- function(input, output, session) {
  output$distancePlot <- renderPlotly({
  # Calculer la distance parcourue par chaque cigogne pour l'ann√©e s√©lectionn√©e
	filtered_data <- subset(cigogne, year(date) == input$annees)
	
	filtered_data$date <- month(filtered_data$date)
	
  names(filtered_data)[names(filtered_data) == "date"] <- "month"
  
  
	 # Calculer la distance parcourue pour chaque cigogne par mois 
  monthly_distance <-
    filtered_data %>%
      group_by(month,nom) %>%
      summarise(distance_totale= sum(distance_between_points(longitude, latitude)))
  
  #et l√† on fait une moyenne des distances de toutes les cigognes sur un mois
  average_distance_per_month <- monthly_distance %>%
  group_by(month) %>%
  summarise(average_distance = mean(distance_totale))
  
  #Cr√©ation des noms des mois
  average_distance_per_month$month_name <- month.name[average_distance_per_month$month]
  
  # Change the month name order to be in the same order as the month number
months_order <- c("January", "February", "March", "April", "May", "June", 
                  "July", "August", "September", "October", "November", "December")
average_distance_per_month$month_name <- factor(average_distance_per_month$month_name, levels = months_order)
  
  # Tracer l'histogramme
  ggplotly(
    ggplot(average_distance_per_month, aes(x = month_name, y = average_distance)) +
      geom_bar(stat = "identity", fill = "skyblue") +
      labs(title = paste("Distance moyenne parcourue par les cigognes sur l'ann√©e", input$annees),
           x = "Mois",
           y = "Distance moyenne parcourue (km)")+  # Ajout de l'unit√© de distance
  	theme(axis.text.x = element_text(angle = -45, hjust = 1))  # Faire pivoter les √©tiquettes de l'axe x pour une meilleure lisibilit√©
  	
  )})
}

# Lancer l'application Shiny
shinyApp(ui = ui, server = server)

```

### Distance Moyenne Parcourue Chaque Mois

```{r}
#Cr√©ation du bon dataset
cigogne <- cigogne_big
# Supprimer la condition de filtrage par ann√©e
filtered_data <- cigogne

# Modifier la colonne de date en mois
filtered_data$month <- month(filtered_data$date)

# Calculer la distance parcourue pour chaque cigogne par mois
monthly_distance <- filtered_data %>%
  group_by(year=year(date), month, tag.local.identifier) %>%
  summarise(distance_totale = sum(distance_between_points(longitude, latitude)))

# Calculer la moyenne des distances de toutes les cigognes sur un mois pour chaque ann√©e
average_distance_per_month <- monthly_distance %>%
  group_by(year, month, .groups = "drop") %>%
  summarise(average_distance = mean(distance_totale))

# Obtenir les noms des mois
average_distance_per_month$month_name <- month.name[average_distance_per_month$month]


# Group the dataframe by 'year', 'month' and 'month_name' and count the number of lines for each month
line_counts <- average_distance_per_month 
# Change the month name order to be in the same order as the month number
months_order <- c("January", "February", "March", "April", "May", "June", 
                  "July", "August", "September", "October", "November", "December")
line_counts$month_name <- factor(line_counts$month_name, levels = months_order)



# Create the line plot
plot <- plot_ly() 

# Add traces for each year
for (year in unique(line_counts$year)) {
  plot <- add_trace(plot, 
                    data = dplyr::filter(line_counts, year == !!year), 
                    x = ~month_name, 
                    y = ~average_distance, 
                    name = year, 
                    type = 'bar', 
                    mode = 'lines+markers')
}

# Add buttons for each year
buttons <- list() 
for (year in unique(line_counts$year)) {
  buttons <- c(buttons, list(
    method = "update",
    args = list(visible = sapply(line_counts$year, function(x) x == year)),
    label = year
  ))
}

# Add the buttons to the layout
plot <- layout(plot, updatemenus = list(
  list(
    buttons = buttons
  )
))

# Render the plot
plot

```

### Distance moyenne parcourue par ann√©e

```{r}
cigogne <- cigogne_big
cigogne_copie <- cigogne
# Transformer les dates pour ne garder que les ann√©es
cigogne_copie$date <- year(cigogne_copie$date)

#calcul des distances parcourues par les diff√©rentes cigognes chaque ann√©e
distance_cigogne <- cigogne_copie %>%
  group_by(date,tag.local.identifier) %>%
  summarise(distance_totale = sum(distance_between_points(longitude, latitude)))

#et l√† on fait une moyenne des distances de toutes les cigognes sur une ann√©e
average_distance_per_year <- distance_cigogne %>%
  group_by(date) %>%
  summarise(average_distance = mean(distance_totale))

# Calculer la moyenne mobile sur une p√©riode de trois mois
average_distance_per_year <- average_distance_per_year %>%
  mutate(moyenne_mobile = rollmean(average_distance, k = 3, fill = NA))

# Cr√©er un graphique √† barres avec une courbe de tendance globale
ggplotly(
ggplot(average_distance_per_year, aes(x = date, y = average_distance)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_line(aes(y = moyenne_mobile), color = "red") +  # Ajouter la ligne de moyenne mobile
  geom_hline(yintercept = median(average_distance_per_year$average_distance), color = "green", linetype = "dashed", size = 1) +  # Ajouter une ligne horizontale pour la m√©diane
  labs(title = "Distance moyenne parcourue par les cigognes par ann√©e",
       x = "Ann√©e",
       y = "Distance moyenne parcourue (km)")
)


```

<div style="margin-left: 50px; margin-right: 50px;"> 

### üìç Conclusion 

#### Analyse de la "Carte de trajectoire de migration pour chaque cigogne" 

Cette carte affiche le d√©placement de chaque cigogne entre 2014 et 2023 (cette p√©riode peut √™tre r√©duite jusqu‚Äô√† une ann√©e pour certaines cigognes, faute de donn√©es). Si un m√™me trajet appara√Æt plusieurs fois sur la carte, cela signifie que nous disposons de plusieurs ann√©es de donn√©es et que la cigogne effectue des allers-retours sur plusieurs ann√©es (ex : Adi). Apr√®s avoir √©tudi√© plusieurs cigognes parmi la liste, il est apparu que celles-ci empruntent diff√©rents itin√©raires lors de leur migration. Certaines cigognes, comme Adi, Ida et Marieta, suivent le m√™me parcours chaque ann√©e, partant d'Allemagne pour se rendre en Espagne, puis effectuant le trajet inverse. Nous remarquons aussi que d‚Äôautres cigognes parcourent encore plus de distance durant leur migration. Par exemple, la cigogne ‚ÄúFranzl‚Äù migre de l'Allemagne jusqu'au S√©n√©gal, tandis que la cigogne ‚ÄúKonrad‚Äù se rend jusqu'au Soudan en passant par la Turquie et l'√âgypte. Les cigognes migrent donc vers le Sud pour trouver des endroits plus chauds durant l‚Äôhiver, car les temp√©ratures moyennes en Allemagne durant l‚Äôhiver sont comprises entre 3 et 6¬∞C, contrairement en Espagne qui sont entre 10 et 18 ¬∞C ou au S√©n√©gal qui sont comprises entre 23¬∞C et 28¬∞C. D‚Äôautres graphiques seront pr√©sent√©s pour permettre d‚Äôaffiner nos recherches et de r√©pondre √† notre probl√©matique.

#### Analyse de la "Distance moyenne parcourue par les cigognes par ann√©e" 

Nous avons repr√©sent√© dans ce tableau la distance moyenne parcourue par les cigognes chaque ann√©e. L‚Äôaugmentation de cette valeur au fil des ann√©es est clairement visible. Nous pouvons d√©duire de cette tendance √† la hausse que les cigognes parcourent plus de distance durant leur migration. Cela peut √™tre d√ª √† plusieurs raisons comme le fait que davantage de cigognes partent en Afrique, ou que plus de cigognes contournent la M√©diterran√©e par la droite ce qui allonge leur trajet. Les cigognes qui vont en Afrique peuvent aussi davantage se rapprocher du Sud, jusqu‚Äôen Afrique du Sud par exemple. On en conclut donc une √©volution du comportement migratoire des cigognes avec une augmentation de plus de 30% des distances parcourues en 10 ans.

Remarque : Il y a un probl√®me d‚Äôaffichage pour l‚Äôann√©e 2016. Le code s‚Äôex√©cute tr√®s bien sur Mac mais lorsque nous passons sur Windows, la valeur de cette ann√©e ne s‚Äôaffiche plus. Voici l‚Äôhistogramme complet en image.

![Histogramme complet](image.png)


#### Analyse de l‚Äô"Histogramme des distances totales parcourues par les cigognes en fonction du mois + ann√©es" 

Nous allons maintenant examiner la p√©riode de migration des cigognes. Cet histogramme constitue une premi√®re visualisation, illustrant la distance totale effectu√©e par chaque cigogne en fonction du mois et de l‚Äôann√©e. En regardant plus en d√©tail, nous nous apercevons que les cigognes parcourent des distances plus importantes durant certains mois de l‚Äôann√©e, en ao√ªt et septembre 2015 ou avril 2015 par exemple. Cependant en 2023, elles parcourent plus de distance en f√©vrier-mars qu‚Äôen avril. Pour mieux observer ces p√©riodes, nous avons cr√©√© le graphique ‚ÄúHistogramme sur un an qui repr√©sente la distance moyenne parcourue des cigognes par mois‚Äù.

#### Analyse de l‚Äô"Histogramme sur un an qui repr√©sente la distance moyenne parcourue des cigognes par mois" 

Ce nouveau graphique permet une meilleure visualisation des diff√©rentes p√©riodes de migration. En 2015, les mois d‚Äôavril, ao√ªt et septembre restent toujours les mois o√π les cigognes effectuent le plus de distance. Une √©volution est toujours observ√©e en 2023, o√π ce sont les mois de f√©vrier-mars et ao√ªt-septembre que les cigognes parcourent le plus de distance. Nous avons r√©alis√© ensuite un dernier graphique pour avoir une vue d'ensemble de l'√©volution au fil du temps.


#### Analyse de l‚Äô"Distance moyenne parcourue par les cigognes par mois sur la p√©riode 2014-2023"‚Äù

Nous avons repr√©sent√© dans ce graphique la distance moyenne parcourue par les cigognes par mois. Nous constatons une augmentation de cette valeur entre 2014 et 2023 pour les mois de f√©vrier et mars, entra√Ænant par cons√©quent une diminution de la valeur pour le mois d‚Äôavril. En revanche, cette distance reste globalement stable pour les mois d‚Äôao√ªt et septembre. Par cons√©quent, nous d√©duisons de ce graphique un changement dans la p√©riode de migration hivernale au fil des ann√©es avec un d√©but de migration plus t√¥t dans l‚Äôann√©e.


 </div>  
 
# üìç Conclusion

#### CONCLUSION FINALE

Pour conclure, au fil des ann√©es, des √©volutions marquantes dans les comportements des animaux, ici des cigognes et des caribous, ont √©t√© observ√©es. Ces changements incluent des variations dans leurs p√©riodes de migration, une augmentation de la distance parcourue pendant leurs d√©placements, ainsi que des modifications de leurs trajets migratoires. Plusieurs facteurs peuvent expliquer ces transformations, parmi lesquels le r√©chauffement climatique joue un r√¥le crucial, comme cela a √©t√© soulign√© dans le cas des caribous.
